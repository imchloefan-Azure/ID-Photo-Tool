import tkinter as tk
from tkinter import filedialog, messagebox
from rembg import remove
from PIL import Image, ImageOps
import io
import cv2
import numpy as np
import os

class IDPhotoApp:
    def __init__(self, root):
            self.root = root
                    self.root.title("一键证件照生成器 (358x441)")
                            self.root.geometry("500x400")
                                    
                                            # 界面布局
                                                    self.label = tk.Label(root, text="请选择一张照片\n支持 .jpg / .png", font=("Arial", 14))
                                                            self.label.pack(pady=40)
                                                                    
                                                                            self.btn_select = tk.Button(root, text="选择图片并处理", command=self.process_image, height=2, width=20, bg="#0078D7", fg="white")
                                                                                    self.btn_select.pack(pady=10)
                                                                                            
                                                                                                    self.status_label = tk.Label(root, text="准备就绪", fg="gray")
                                                                                                            self.status_label.pack(side=tk.BOTTOM, pady=10)

                                                                                                                def process_image(self):
                                                                                                                        # 1. 选择文件
                                                                                                                                file_path = filedialog.askopenfilename(filetypes=[("Image files", "*.jpg;*.jpeg;*.png")])
                                                                                                                                        if not file_path:
                                                                                                                                                    return
                                                                                                                                                            
                                                                                                                                                                    self.status_label.config(text="正在处理中，请稍候... (AI 抠图中)")
                                                                                                                                                                            self.root.update()

                                                                                                                                                                                    try:
                                                                                                                                                                                                # 2. 读取图片并移除背景
                                                                                                                                                                                                            with open(file_path, "rb") as input_file:
                                                                                                                                                                                                                            input_data = input_file.read()
                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                    # 使用 rembg 移除背景
                                                                                                                                                                                                                                                                output_data = remove(input_data)
                                                                                                                                                                                                                                                                            img_rgba = Image.open(io.BytesIO(output_data)).convert("RGBA")
                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                    # 3. 转换为 OpenCV 格式进行人脸识别
                                                                                                                                                                                                                                                                                                                # 将 RGBA 转为 RGB 用于人脸检测
                                                                                                                                                                                                                                                                                                                            img_rgb_cv = cv2.cvtColor(np.array(img_rgba.convert("RGB")), cv2.COLOR_RGB2BGR)
                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                    # 加载人脸识别模型 (OpenCV 内置)
                                                                                                                                                                                                                                                                                                                                                                face_cascade = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml')
                                                                                                                                                                                                                                                                                                                                                                            faces = face_cascade.detectMultiScale(img_rgb_cv, 1.1, 5, minSize=(50, 50))

                                                                                                                                                                                                                                                                                                                                                                                        if len(faces) == 0:
                                                                                                                                                                                                                                                                                                                                                                                                        messagebox.showwarning("警告", "未检测到人脸，将直接缩放图片。")
                                                                                                                                                                                                                                                                                                                                                                                                                        final_img = self.simple_resize(img_rgba)
                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                    # 取最大的人脸
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    x, y, w, h = max(faces, key=lambda f: f[2] * f[3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    final_img = self.smart_crop(img_rgba, x, y, w, h)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 4. 叠加白底
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            white_bg = Image.new("RGBA", final_img.size, "WHITE")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        white_bg.paste(final_img, (0, 0), final_img)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    final_jpg = white_bg.convert("RGB")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 5. 保存图片
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            save_path = filedialog.asksaveasfilename(defaultextension=".jpg", filetypes=[("JPEG", "*.jpg")], initialfile="证件照_358x441.jpg")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if save_path:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_jpg.save(save_path, quality=95)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.status_label.config(text=f"保存成功：{os.path.basename(save_path)}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        messagebox.showinfo("成功", "证件照已生成并保存！")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.status_label.config(text="取消保存")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.status_label.config(text="发生错误")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    messagebox.showerror("错误", str(e))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def smart_crop(self, img, fx, fy, fw, fh):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        根据人脸位置进行智能裁剪
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fx, fy, fw, fh: 人脸的坐标和宽高
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                img_w, img_h = img.size
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # --- 参数设置 ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        target_w, target_h = 358, 441
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                target_ratio = target_w / target_h
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 设定裁剪框的宽度为脸宽的倍数 (比如 2.2 倍，包含肩膀)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        crop_w = fw * 2.2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                crop_h = crop_w / target_ratio
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 计算裁剪框中心
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        center_x = fx + fw / 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 计算裁剪框顶部 (脸顶上方留出脸高的 0.6 倍作为头部留白)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 这里的系数越小，头顶留白越少
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        crop_y = fy - (fh * 0.8) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 计算裁剪框坐标 (left, top, right, bottom)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                left = center_x - crop_w / 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        top = crop_y
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                right = left + crop_w
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        bottom = top + crop_h
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # --- 坐标转换与填充 ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 如果计算出的裁剪框超出了原图范围，我们需要先扩展原图画布，防止变形
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 使用 ImageOps.pad 或者手动计算粘贴位置比较复杂，这里用简单方法：
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 先按比例 Crop，如果出界，就填充白色
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 转换为整数
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        left, top, right, bottom = map(int, [left, top, right, bottom])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 裁剪出该区域 (PIL 的 crop 允许超出边界，超出部分需要自行处理，这里我们先裁切有效区域)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 更好的方法：直接从原图中心向外扩充，然后 Resize
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 简单策略：先以 crop_w, crop_h 为基准，从原图抠图，出界部分填白
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 创建一个新的透明底板
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                canvas = Image.new("RGBA", (int(crop_w), int(crop_h)), (255, 255, 255, 0))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 计算原图在 canvas 上的粘贴位置
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 原图的 (left, top) 对应 canvas 的 (0,0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 所以原图的 (0,0) 对应 canvas 的 (-left, -top)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        canvas.paste(img, (-left, -top), img)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 最后缩放到目标尺寸
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return canvas.resize((target_w, target_h), Image.Resampling.LANCZOS)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def simple_resize(self, img):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # 简单的居中裁剪缩放作为备选方案
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return ImageOps.fit(img, (358, 441), method=Image.Resampling.LANCZOS)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        root = tk.Tk()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app = IDPhotoApp(root)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                root.mainloop()